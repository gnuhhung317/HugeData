FROM python:3.10-slim AS builder

RUN apt-get update && apt-get install -y \
    libgl1 libglib2.0-0 ca-certificates && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app

RUN pip install --no-cache-dir --upgrade pip setuptools wheel && \
    pip install --no-cache-dir \
        numpy \
        kafka-python \
        requests \
        opencv-python-headless && \
    pip install --no-cache-dir \
        torch==2.3.0+cpu torchvision==0.18.0+cpu torchaudio==2.3.0+cpu \
        --index-url https://download.pytorch.org/whl/cpu && \
    pip install --no-cache-dir ultralytics

COPY . .

FROM python:3.10-slim

RUN apt-get update && apt-get install -y \
    libgl1 libglib2.0-0 netcat-openbsd ca-certificates && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY --from=builder /usr/local/lib/python3.10/site-packages /usr/local/lib/python3.10/site-packages
COPY --from=builder /usr/local/bin /usr/local/bin
COPY . .
RUN rm -rf /root/.cache /tmp/*

CMD ["./wait-for-kafka.sh", "python", "producer.py"]
